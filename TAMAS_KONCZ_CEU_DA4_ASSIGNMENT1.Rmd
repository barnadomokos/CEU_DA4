---
title: "DA4 -  Assignment 1"
author: "Tamas Koncz"
date: '2018-02-11'
output:
  html_document:
    df_print: paged
  html_notebook:
    df_print: paged
---

```{r, message=FALSE}
require(data.table)
require(ggplot2)
require(gridExtra)
require(caret)

options(scipen = 999)

theme_set(theme_minimal())   # globally set ggplot theme

set.seed(1234)
RMSE <- function(x, true_x) sqrt(mean((x - true_x)^2))
```


```{r}
data <- fread("airbnb_london_workfile.csv", stringsAsFactors = FALSE)
```

##### Code snippet for selecting random borough: 

```{r}
boroughs <- data[, .(count = .N, 
                     avg_price = mean(price)), 
                 keyby = f_neighbourhood_cleansed][order(-count)]

boroughs[, borough := factor(f_neighbourhood_cleansed, 
                             levels = boroughs[order(count)][, f_neighbourhood_cleansed])]
boroughs[, f_neighbourhood_cleansed := NULL]

# randomly picking an area > 1000
set.seed(93) #for reproducibility
selected <- sample(boroughs[count > 1000]$borough, 1)

```

```{r, fig.align= 'center', fig.width= 10}
max_count <- boroughs[, max(count)]
max_avg_price <- boroughs[, max(avg_price)]

boroughs[borough == selected, ] #TODO: make this bold on the chart

ggplot(data = boroughs) + 
  geom_bar(data = boroughs[borough == selected], aes(x = borough, y = 6000), fill = "lightblue",  stat = "identity") +
  geom_point(aes(x = borough, y = count, color = "# of Observations"), shape = 20, size = 2) +
  geom_segment(aes(x = borough, y = count, xend = borough, yend =0, color = "# of Observations")) + 
  geom_point(aes(x = borough, y = avg_price * (max_count/max_avg_price), color = "Avg. Price"), shape = 4, size = 2) + 
  scale_y_continuous(sec.axis = sec_axis(~./(max_count/max_avg_price), name = "Avg. Price")) + 
  scale_color_manual(name = "Legend", values = c("# of Observations" = "tomato", "Avg. Price" = "darkblue")) + 
  guides(color=guide_legend(override.aes=list(shape=15))) +
  labs(y = "# of Observations", x = "Borough") +
  coord_flip()
```

```{r}
names(data)[1:20]
```
```{r}
london <- copy(data)
london[, log_price:= log(price)]
kensington_chelsea <- london[f_neighbourhood_cleansed == selected]
```


```{r}
ggplot(data= london, aes(x = log_pricelog(price))) + geom_histogram()
ggplot(data= kensington_chelsea, aes(x = log_price)) + geom_histogram()

# TODO: add reasoning for log transformation. two hist, not-log, common density, log

ggplot(data= london, aes(x = n_accommodates)) + geom_histogram()
ggplot(data= london, aes(x = n_accommodates, y = log_price)) + geom_point() + geom_smooth()

ggplot(data= london, aes(x = n_beds)) + geom_histogram()
ggplot(data= london, aes(x = n_beds, y = log_price)) + geom_point() + geom_smooth()
#transform both for deminishing returns?

# f_room_type
ggplot(data= london, aes(x = f_room_type)) + geom_bar()
ggplot(data= london, aes(x = f_room_type, y = log_price)) + geom_boxplot()

# f_cancellation_policy -> surprising result. correlation with sth else?
ggplot(data= london, aes(x = f_cancellation_policy)) + geom_bar()
ggplot(data= london, aes(x = f_cancellation_policy, y = log_price)) + geom_boxplot()

#d_breakfast -> no big impact. add d_ to TOTAL?
ggplot(data= london, aes(x = d_breakfast)) + geom_bar()
ggplot(data= london, aes(x = factor(d_breakfast), y = log_price)) + geom_boxplot()

#n_number_of_reviews
ggplot(data= london, aes(x = n_number_of_reviews)) + geom_histogram()
ggplot(data= kensington_chelsea, aes(x = n_number_of_reviews, y = log_price)) + geom_point() + geom_smooth()

#n_minimum_nights --> some outliers, handle
ggplot(data= london, aes(x = n_minimum_nights)) + geom_histogram()
ggplot(data= london, aes(x = n_minimum_nights, y = log_price)) + geom_point() + geom_smooth()

#f_property_type --> some interaction with other variables, eg. room type?
ggplot(data= london, aes(x = f_property_type)) + geom_bar()
ggplot(data= london, aes(x = f_property_type, y = log_price)) + geom_boxplot()

# usd_cleaning_fee --> model non-linearity?
london[, cleaning_fee := ifelse(is.na(usd_cleaning_fee), 0, usd_cleaning_fee)]
ggplot(data= london, aes(x = cleaning_fee)) + geom_histogram()
ggplot(data= london, aes(x = cleaning_fee, y = log_price)) + geom_point() + geom_smooth()
```

